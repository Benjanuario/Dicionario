<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizar Banco de Dados - Dicion√°rio Emakhua</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .word-list {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }
        
        .word-item {
            display: grid;
            grid-template-columns: 50px 1fr 1fr 100px 100px;
            gap: 15px;
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            align-items: center;
        }
        
        .word-item:last-child {
            border-bottom: none;
        }
        
        .word-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .table-header {
            background: rgba(255, 255, 255, 0.15);
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .search-box {
            margin-bottom: 20px;
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 20px 12px 45px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
        }
        
        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.6);
        }
        
        .export-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }
        
        .export-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        .export-card h3 {
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        .export-card p {
            margin-bottom: 15px;
            opacity: 0.8;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .word-item {
                grid-template-columns: 1fr;
                gap: 5px;
            }
            
            .table-header {
                display: none;
            }
            
            .word-item::before {
                content: attr(data-label);
                font-weight: 600;
                color: rgba(255, 255, 255, 0.7);
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Visualiza√ß√£o do Banco de Dados</h1>
            <p>Dicion√°rio Emakhua-Portugu√™s | Total de palavras cadastradas</p>
        </div>
        
        <div class="controls">
            <button class="btn" onclick="loadAllWords()">
                <i class="fas fa-sync"></i> Carregar Tudo
            </button>
            <button class="btn" onclick="exportToCSV()">
                <i class="fas fa-file-csv"></i> Exportar CSV
            </button>
            <button class="btn" onclick="exportToJSON()">
                <i class="fas fa-file-code"></i> Exportar JSON
            </button>
            <button class="btn" onclick="downloadBackup()">
                <i class="fas fa-download"></i> Backup Completo
            </button>
        </div>
        
        <div class="search-box">
            <i class="fas fa-search search-icon"></i>
            <input type="text" 
                   class="search-input" 
                   id="searchInput"
                   placeholder="Buscar palavra em Emakhua ou Portugu√™s..."
                   onkeyup="filterWords()">
        </div>
        
        <div class="stats" id="stats">
            <!-- Estat√≠sticas carregadas por JS -->
        </div>
        
        <div class="word-list">
            <div class="word-item table-header">
                <div>ID</div>
                <div>Emakhua</div>
                <div>Portugu√™s</div>
                <div>Classe</div>
                <div>Tom</div>
            </div>
            <div id="wordsContainer">
                <!-- Palavras carregadas por JavaScript -->
            </div>
        </div>
        
        <div class="export-options">
            <div class="export-card">
                <h3>üìÑ Exportar para CSV</h3>
                <p>Formato compat√≠vel com Excel e Google Sheets</p>
                <button class="btn" onclick="exportToCSV()">
                    <i class="fas fa-file-excel"></i> Gerar CSV
                </button>
            </div>
            
            <div class="export-card">
                <h3>üìä Exportar para JSON</h3>
                <p>Para backup ou uso em outros sistemas</p>
                <button class="btn" onclick="exportToJSON()">
                    <i class="fas fa-file-code"></i> Gerar JSON
                </button>
            </div>
            
            <div class="export-card">
                <h3>üíæ Backup do Banco</h3>
                <p>Arquivo SQLite completo para restaura√ß√£o</p>
                <button class="btn" onclick="downloadBackup()">
                    <i class="fas fa-database"></i> Fazer Backup
                </button>
            </div>
            
            <div class="export-card">
                <h3>üñ®Ô∏è Imprimir Lista</h3>
                <p>Imprima a lista completa de palavras</p>
                <button class="btn" onclick="printList()">
                    <i class="fas fa-print"></i> Imprimir
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // Banco de dados
        let db = null;
        let allWords = [];
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Carregando visualiza√ß√£o do banco de dados...');
            await initDatabase();
        });
        
        // Inicializar banco de dados
        async function initDatabase() {
            try {
                // Carregar SQL.js se n√£o estiver carregado
                if (typeof initSqlJs === 'undefined') {
                    await loadScript('lib/sql-wasm.js');
                }
                
                // Carregar banco do localStorage
                const savedDB = localStorage.getItem('emakhua_database_v2');
                if (!savedDB) {
                    showMessage('‚ö†Ô∏è Nenhum banco de dados encontrado!');
                    return;
                }
                
                const SQL = await initSqlJs({
                    locateFile: file => `lib/${file}`
                });
                
                const data = new Uint8Array(JSON.parse(savedDB));
                db = new SQL.Database(data);
                
                console.log('‚úÖ Banco carregado com sucesso');
                loadAllWords();
                updateStats();
                
            } catch (error) {
                console.error('Erro ao carregar banco:', error);
                showMessage('‚ùå Erro ao carregar banco de dados');
            }
        }
        
        // Carregar script
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        
        // Carregar todas as palavras
        function loadAllWords() {
            if (!db) {
                showMessage('Banco de dados n√£o carregado');
                return;
            }
            
            try {
                const stmt = db.prepare(`
                    SELECT id, emakhua, portugues, classe_gramatical, tom, 
                           exemplo_emakhua, dialeto, verificada, data_cadastro
                    FROM palavras 
                    ORDER BY emakhua COLLATE NOCASE
                `);
                
                allWords = [];
                while (stmt.step()) {
                    allWords.push(stmt.getAsObject());
                }
                stmt.free();
                
                displayWords(allWords);
                updateStats();
                
            } catch (error) {
                console.error('Erro ao carregar palavras:', error);
                showMessage('Erro ao carregar palavras');
            }
        }
        
        // Exibir palavras
        function displayWords(words) {
            const container = document.getElementById('wordsContainer');
            
            if (words.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.7);">
                        <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>Nenhuma palavra encontrada</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            words.forEach(word => {
                html += `
                    <div class="word-item" 
                         data-label="ID: ${word.id} | ${word.emakhua} ‚Üí ${word.portugues}">
                        <div>${word.id}</div>
                        <div style="font-weight: 600;">${escapeHtml(word.emakhua)}</div>
                        <div>${escapeHtml(word.portugues)}</div>
                        <div>${word.classe_gramatical || '-'}</div>
                        <div>${word.tom || '-'}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Filtrar palavras
        function filterWords() {
            const termo = document.getElementById('searchInput').value.toLowerCase();
            
            if (!termo) {
                displayWords(allWords);
                return;
            }
            
            const filtered = allWords.filter(word => 
                word.emakhua.toLowerCase().includes(termo) ||
                word.portugues.toLowerCase().includes(termo)
            );
            
            displayWords(filtered);
        }
        
        // Atualizar estat√≠sticas
        function updateStats() {
            if (!db) return;
            
            try {
                // Total de palavras
                const total = db.exec('SELECT COUNT(*) as total FROM palavras')[0]?.values[0][0] || 0;
                
                // Palavras verificadas
                const verificadas = db.exec('SELECT COUNT(*) as total FROM palavras WHERE verificada = 1')[0]?.values[0][0] || 0;
                
                // √öltima atualiza√ß√£o
                const ultima = db.exec('SELECT MAX(data_cadastro) as ultima FROM palavras')[0]?.values[0][0] || 'N/A';
                
                // Por classe gramatical
                const classes = db.exec('SELECT COUNT(DISTINCT classe_gramatical) as classes FROM palavras')[0]?.values[0][0] || 0;
                
                const statsHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${total}</div>
                        <div class="stat-label">Total de Palavras</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${verificadas}</div>
                        <div class="stat-label">Verificadas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${classes}</div>
                        <div class="stat-label">Classes Gramaticais</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${allWords.length}</div>
                        <div class="stat-label">Carregadas</div>
                    </div>
                `;
                
                document.getElementById('stats').innerHTML = statsHTML;
                
            } catch (error) {
                console.error('Erro ao atualizar estat√≠sticas:', error);
            }
        }
        
        // ========== EXPORTA√á√ÉO ==========
        
        // Exportar para CSV
        function exportToCSV() {
            if (allWords.length === 0) {
                alert('Nenhuma palavra para exportar');
                return;
            }
            
            // Cabe√ßalhos
            const headers = ['ID', 'Emakhua', 'Portugu√™s', 'Classe', 'Tom', 'Dialeto', 'Verificada', 'Data Cadastro'];
            
            // Dados
            const csvRows = [
                headers.join(','),
                ...allWords.map(word => [
                    word.id,
                    `"${word.emakhua}"`,
                    `"${word.portugues}"`,
                    `"${word.classe_gramatical || ''}"`,
                    `"${word.tom || ''}"`,
                    `"${word.dialeto || ''}"`,
                    word.verificada ? 'Sim' : 'N√£o',
                    `"${word.data_cadastro || ''}"`
                ].join(','))
            ];
            
            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `emakhua-palavras-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            URL.revokeObjectURL(url);
            
            showMessage(`‚úÖ CSV exportado com ${allWords.length} palavras`);
        }
        
        // Exportar para JSON
        function exportToJSON() {
            if (allWords.length === 0) {
                alert('Nenhuma palavra para exportar');
                return;
            }
            
            const dados = {
                metadata: {
                    export_date: new Date().toISOString(),
                    total_words: allWords.length,
                    version: '1.0'
                },
                palavras: allWords
            };
            
            const jsonString = JSON.stringify(dados, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `emakhua-palavras-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            
            showMessage(`‚úÖ JSON exportado com ${allWords.length} palavras`);
        }
        
        // Fazer backup do banco
        function downloadBackup() {
            if (!db) {
                alert('Banco de dados n√£o carregado');
                return;
            }
            
            try {
                const dados = db.export();
                const blob = new Blob([dados], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `emakhua-backup-${new Date().toISOString().split('T')[0]}.sqlite`;
                link.click();
                
                URL.revokeObjectURL(url);
                
                showMessage(`‚úÖ Backup criado (${Math.round(dados.byteLength / 1024)} KB)`);
                
            } catch (error) {
                console.error('Erro ao criar backup:', error);
                showMessage('‚ùå Erro ao criar backup');
            }
        }
        
        // Imprimir lista
        function printList() {
            const printWindow = window.open('', '_blank');
            
            let html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Lista de Palavras Emakhua</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { text-align: center; color: #333; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th { background: #f0f0f0; padding: 10px; text-align: left; border: 1px solid #ddd; }
                        td { padding: 8px; border: 1px solid #ddd; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .footer { margin-top: 30px; text-align: center; font-size: 12px; color: #666; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Dicion√°rio Emakhua-Portugu√™s</h1>
                        <p>Lista completa de palavras | ${new Date().toLocaleDateString()}</p>
                        <p>Total: ${allWords.length} palavras</p>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Emakhua</th>
                                <th>Portugu√™s</th>
                                <th>Classe</th>
                                <th>Tom</th>
                                <th>Data</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            allWords.forEach(word => {
                html += `
                    <tr>
                        <td>${word.id}</td>
                        <td>${escapeHtml(word.emakhua)}</td>
                        <td>${escapeHtml(word.portugues)}</td>
                        <td>${word.classe_gramatical || ''}</td>
                        <td>${word.tom || ''}</td>
                        <td>${word.data_cadastro ? word.data_cadastro.split('T')[0] : ''}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <p>Dicion√°rio Emakhua-Portugu√™s ¬© ${new Date().getFullYear()} | By Prof. Nito</p>
                    </div>
                    
                    <script>
                        window.onload = function() {
                            window.print();
                        };
                    </script>
                </body>
                </html>
            `;
            
            printWindow.document.write(html);
            printWindow.document.close();
        }
        
        // Mostrar detalhes completos de uma palavra
        function showWordDetails(id) {
            if (!db) return;
            
            try {
                const stmt = db.prepare('SELECT * FROM palavras WHERE id = ?');
                stmt.bind([id]);
                
                const palavra = stmt.step() ? stmt.getAsObject() : null;
                stmt.free();
                
                if (palavra) {
                    const detalhes = `
                        <strong>ID:</strong> ${palavra.id}<br>
                        <strong>Emakhua:</strong> ${palavra.emakhua}<br>
                        <strong>Portugu√™s:</strong> ${palavra.portugues}<br>
                        <strong>Classe:</strong> ${palavra.classe_gramatical || 'N√£o especificado'}<br>
                        <strong>Tom:</strong> ${palavra.tom || 'N√£o especificado'}<br>
                        <strong>Dialeto:</strong> ${palavra.dialeto || 'Padr√£o'}<br>
                        <strong>Verificada:</strong> ${palavra.verificada ? '‚úÖ Sim' : '‚ùå N√£o'}<br>
                        <strong>Exemplo:</strong> ${palavra.exemplo_emakhua || 'N√£o informado'}<br>
                        <strong>Tradu√ß√£o exemplo:</strong> ${palavra.exemplo_traducao || 'N√£o informado'}<br>
                        <strong>Notas:</strong> ${palavra.notas || 'N√£o informado'}<br>
                        <strong>Data cadastro:</strong> ${palavra.data_cadastro || 'N√£o informado'}<br>
                        <strong>√öltima atualiza√ß√£o:</strong> ${palavra.data_atualizacao || 'N√£o informado'}
                    `;
                    
                    alert(detalhes);
                }
                
            } catch (error) {
                console.error('Erro ao buscar detalhes:', error);
            }
        }
        
        // Utilit√°rios
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function showMessage(text) {
            alert(text);
        }
    </script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</body>
</html>
