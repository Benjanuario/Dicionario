<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Dicion√°rio Emakhua</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --primary: #2c5282;
      --secondary: #38a169;
      --danger: #e53e3e;
      --light: #f7fafc;
      --dark: #2d3748;
      --border: #e2e8f0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--light);
      color: var(--dark);
      line-height: 1.6;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .panel {
      display: block;
    }
    
    .header {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      background: white;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .tab {
      padding: 10px 20px;
      border: none;
      background: var(--light);
      color: var(--dark);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .tab.active {
      background: var(--primary);
      color: white;
    }
    
    .tab:hover {
      transform: translateY(-2px);
    }
    
    .content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
    }
    
    .form-control {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--border);
      border-radius: 6px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: #2b6cb0;
      transform: translateY(-2px);
    }
    
    .btn-success {
      background: var(--secondary);
      color: white;
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-block {
      width: 100%;
    }
    
    .word-list {
      max-height: 500px;
      overflow-y: auto;
      margin-top: 20px;
    }
    
    .word-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border-bottom: 1px solid var(--border);
    }
    
    .word-item:hover {
      background: var(--light);
    }
    
    .word-info {
      flex: 1;
    }
    
    .word-emakhua {
      font-weight: 600;
      font-size: 1.1rem;
      color: var(--primary);
    }
    
    .word-actions {
      display: flex;
      gap: 10px;
    }
    
    .message {
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
    }
    
    .success {
      background: #c6f6d5;
      color: #22543d;
      border: 1px solid #9ae6b4;
    }
    
    .error {
      background: #fed7d7;
      color: #742a2a;
      border: 1px solid #fc8181;
    }
    
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
      .container {
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="panel">
    <div class="container">
      <!-- Header -->
      <div class="header">
        <h1>üìù Administra√ß√£o do Dicion√°rio</h1>
        <a href="index.html" class="btn btn-danger">Voltar</a>
      </div>
      
      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" data-tab="add">‚ûï Adicionar</button>
        <button class="tab" data-tab="list">üìã Listar</button>
        <button class="tab" data-tab="export">üíæ Exportar</button>
        <button class="tab" data-tab="import">üì§ Importar</button>
      </div>
      
      <!-- Mensagens -->
      <div id="message" class="message" style="display: none;"></div>
      
      <!-- Conte√∫do das Tabs -->
      <div id="addTab" class="content tab-content active">
        <h2 style="margin-bottom: 20px;">Adicionar Nova Palavra</h2>
        <div class="form-group">
          <label for="emakhua">Palavra em Emakhua *</label>
          <input type="text" id="emakhua" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="portugues">Tradu√ß√£o em Portugu√™s *</label>
          <input type="text" id="portugues" class="form-control" required>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="classe">Classe Gramatical</label>
            <select id="classe" class="form-control">
              <option value="">Selecione...</option>
              <option value="substantivo">Substantivo</option>
              <option value="verbo">Verbo</option>
              <option value="adjetivo">Adjetivo</option>
              <option value="adv√©rbio">Adv√©rbio</option>
            </select>
          </div>
          <div class="form-group">
            <label for="tom">Padr√£o de Tom</label>
            <input type="text" id="tom" class="form-control" placeholder="HL, LHL, etc.">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="exemplo_emakhua">Exemplo em Emakhua</label>
            <textarea id="exemplo_emakhua" class="form-control"></textarea>
          </div>
          <div class="form-group">
            <label for="exemplo_traducao">Tradu√ß√£o do Exemplo</label>
            <textarea id="exemplo_traducao" class="form-control"></textarea>
          </div>
        </div>
        <button class="btn btn-primary" onclick="addWord()">Adicionar Palavra</button>
      </div>
      
      <div id="listTab" class="content tab-content">
        <h2 style="margin-bottom: 20px;">Palavras Cadastradas</h2>
        <div class="form-group">
          <input type="text" 
                 id="searchInput" 
                 class="form-control" 
                 placeholder="Buscar palavra..."
                 onkeyup="searchWordsList()">
        </div>
        <div class="word-list" id="wordList"></div>
      </div>
      
      <div id="exportTab" class="content tab-content">
        <h2 style="margin-bottom: 20px;">Exportar Dados</h2>
        <div style="display: grid; gap: 20px;">
          <div>
            <h3>Exportar para JSON</h3>
            <button class="btn btn-success" onclick="exportJSON()">üìÑ Exportar JSON</button>
          </div>
          <div>
            <h3>Fazer Backup</h3>
            <button class="btn btn-primary" onclick="backupDatabase()">üíæ Fazer Backup</button>
          </div>
          <div>
            <h3>Exportar para CSV</h3>
            <button class="btn" onclick="exportCSV()">üìä Exportar CSV</button>
          </div>
        </div>
      </div>
      
      <div id="importTab" class="content tab-content">
        <h2 style="margin-bottom: 20px;">Importar Dados</h2>
        <div style="display: grid; gap: 20px;">
          <div>
            <h3>Importar do JSON</h3>
            <input type="file" id="jsonFile" accept=".json" style="margin-bottom: 10px;">
            <button class="btn btn-primary" onclick="importJSON()">üì§ Importar JSON</button>
          </div>
          <div>
            <h3>Importar Texto</h3>
            <p style="margin: 10px 0; color: #666;">Formato: emakhua;portugu√™s;classe;tom</p>
            <textarea id="importText" class="form-control" rows="6" placeholder="mu…æ√©;c√£o, cachorro;substantivo;HL"></textarea>
            <button class="btn" onclick="importText()" style="margin-top: 10px;">üìù Importar Texto</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
  <script src="shared-database.js"></script>
  <script>
    // Inicializar ao carregar
    document.addEventListener('DOMContentLoaded', async () => {
      const success = await SharedDB.init();
      if (success) {
        loadWordList();
        setupTabs();
      } else {
        showMessage('Erro ao carregar banco', 'error');
      }
    });

    // Fun√ß√µes de admin
    function addWord() {
      const palavra = {
        emakhua: document.getElementById('emakhua').value.trim(),
        portugues: document.getElementById('portugues').value.trim(),
        classe_gramatical: document.getElementById('classe').value || null,
        tom: document.getElementById('tom').value.trim() || null,
        exemplo_emakhua: document.getElementById('exemplo_emakhua').value.trim() || null,
        exemplo_traducao: document.getElementById('exemplo_traducao').value.trim() || null
      };

      if (!palavra.emakhua || !palavra.portugues) {
        showMessage('Preencha Emakhua e Portugu√™s!', 'error');
        return;
      }

      const result = SharedDB.addWord(palavra);
      if (result.success) {
        document.getElementById('emakhua').value = '';
        document.getElementById('portugues').value = '';
        document.getElementById('classe').value = '';
        document.getElementById('tom').value = '';
        document.getElementById('exemplo_emakhua').value = '';
        document.getElementById('exemplo_traducao').value = '';
        loadWordList();
        showMessage(`‚úÖ "${palavra.emakhua}" adicionada!`, 'success');
        dispatchDatabaseUpdate();
      } else {
        showMessage(`‚ùå ${result.error}`, 'error');
      }
    }

    function loadWordList() {
      const palavras = SharedDB.getAllWords();
      renderWordList(palavras);
    }

    function searchWordsList() {
      const term = document.getElementById('searchInput').value.toLowerCase().trim();
      const allWords = SharedDB.getAllWords();
      const filtered = term
        ? allWords.filter(w =>
            w.emakhua.toLowerCase().includes(term) ||
            w.portugues.toLowerCase().includes(term)
          )
        : allWords;
      renderWordList(filtered);
    }

    function renderWordList(words) {
      const container = document.getElementById('wordList');
      if (!words || words.length === 0) {
        container.innerHTML = '<p style="text-align:center;padding:40px;color:#666;">Nenhuma palavra cadastrada.</p>';
        return;
      }
      let html = '';
      words.forEach(p => {
        html += `
          <div class="word-item">
            <div class="word-info">
              <div class="word-emakhua">${escapeHtml(p.emakhua)}</div>
              <div>${escapeHtml(p.portugues)}</div>
              <small>${p.classe_gramatical ? `Classe: ${p.classe_gramatical}` : ''} ${p.tom ? `| Tom: ${p.tom}` : ''}</small>
            </div>
            <div class="word-actions">
              <button class="btn btn-danger" style="padding:5px 10px;font-size:0.9rem;" onclick="deleteWord(${p.id})">Excluir</button>
            </div>
          </div>
        `;
      });
      container.innerHTML = html;
    }

    function deleteWord(id) {
      if (!confirm('Excluir esta palavra?')) return;
      SharedDB.db.run('UPDATE palavras SET ativo = 0 WHERE id = ?', [id]);
      SharedDB.saveToLocalStorage();
      loadWordList();
      showMessage('Palavra exclu√≠da!', 'success');
      dispatchDatabaseUpdate();
    }

    function exportJSON() {
      const palavras = SharedDB.getAllWords();
      const data = JSON.stringify({
        palavras,
        metadata: { export_date: new Date().toISOString(), total: palavras.length }
      }, null, 2);
      downloadFile(data, 'dicionario-emakhua.json', 'application/json');
      showMessage('‚úÖ JSON exportado!', 'success');
    }

    function backupDatabase() {
      const backup = SharedDB.backup();
      if (backup) {
        const blob = new Blob([backup.data], { type: 'application/octet-stream' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `emakhua-backup-${new Date().toISOString().split('T')[0]}.sqlite`;
        a.click();
        URL.revokeObjectURL(url);
        showMessage(`‚úÖ Backup salvo (${Math.round(backup.size / 1024)} KB)`, 'success');
      }
    }

    function exportCSV() {
      const palavras = SharedDB.getAllWords();
      const headers = ['ID','Emakhua','Portugu√™s','Classe','Tom','Exemplo Emakhua','Tradu√ß√£o Exemplo'];
      const rows = palavras.map(w => [
        w.id,
        `"${w.emakhua}"`,
        `"${w.portugues}"`,
        `"${w.classe_gramatical || ''}"`,
        `"${w.tom || ''}"`,
        `"${w.exemplo_emakhua || ''}"`,
        `"${w.exemplo_traducao || ''}"`
      ]);
      const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
      downloadFile(csv, 'dicionario-emakhua.csv', 'text/csv');
      showMessage(`‚úÖ CSV exportado (${palavras.length} palavras)`, 'success');
    }

    function importJSON() {
      const file = document.getElementById('jsonFile').files[0];
      if (!file) { showMessage('Selecione um arquivo', 'error'); return; }
      if (!confirm('Substituir todos os dados?')) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          SharedDB.db.run('DELETE FROM palavras');
          const stmt = SharedDB.db.prepare(`
            INSERT INTO palavras (emakhua, portugues, classe_gramatical, tom, exemplo_emakhua, exemplo_traducao, verificada)
            VALUES (?, ?, ?, ?, ?, ?, 1)
          `);
          data.palavras.forEach(w => {
            stmt.run([w.emakhua, w.portugues, w.classe_gramatical, w.tom, w.exemplo_emakhua, w.exemplo_traducao]);
          });
          stmt.free();
          SharedDB.saveToLocalStorage();
          loadWordList();
          showMessage('‚úÖ Dados importados!', 'success');
          dispatchDatabaseUpdate();
        } catch (err) {
          showMessage('‚ùå Erro ao importar JSON', 'error');
        }
      };
      reader.readAsText(file);
    }

    function importText() {
      const text = document.getElementById('importText').value.trim();
      if (!text) return;
      const lines = text.split('\n');
      let count = 0;
      const stmt = SharedDB.db.prepare(`
        INSERT INTO palavras (emakhua, portugues, classe_gramatical, tom, verificada)
        VALUES (?, ?, ?, ?, 1)
      `);
      lines.forEach(line => {
        const parts = line.split(';').map(p => p.trim());
        if (parts.length >= 2) {
          stmt.run([parts[0], parts[1], parts[2] || null, parts[3] || null]);
          count++;
        }
      });
      stmt.free();
      SharedDB.saveToLocalStorage();
      document.getElementById('importText').value = '';
      loadWordList();
      showMessage(`‚úÖ ${count} palavras importadas!`, 'success');
      dispatchDatabaseUpdate();
    }

    // Utilit√°rios
    function setupTabs() {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById(tab.dataset.tab + 'Tab').classList.add('active');
        });
      });
    }

    function showMessage(text, type) {
      const el = document.getElementById('message');
      el.textContent = text;
      el.className = `message ${type}`;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 5000);
    }

    function dispatchDatabaseUpdate() {
      localStorage.setItem('db_last_update', new Date().toISOString());
      window.dispatchEvent(new CustomEvent('databaseUpdated'));
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function downloadFile(content, filename, type) {
      const blob = new Blob([content], { type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
